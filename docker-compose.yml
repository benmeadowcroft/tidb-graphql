# Development environment: TiDB + tidb-graphql
#
# Usage:
#   docker compose up          (or podman compose up)
#   docker compose up -d       (detached mode)
#   docker compose up --build  (rebuild after code changes)
#   docker compose down        (stop and remove)
#   docker compose down -v     (stop and remove, including data volume)
#
# GraphiQL interactive explorer: http://localhost:8080/graphql
# TiDB MySQL protocol: localhost:4000
#
# On first run, sample data is loaded from docs/tutorials/sample-data.sql
# by the seed service after TiDB is healthy.
# Data persists across restarts in the 'tidb-data' volume.
#
# Customize settings by creating a .env file (see .env.example).

services:
  tidb:
    image: pingcap/tidb:v8.5.5  # all-in-one TiDB image with TiKV and PD included
    command:
      - "--config=/tidb.toml"
    volumes:
      - ./config/tidb/tidb.toml:/tidb.toml:ro         # custom tidb configuration
      - tidb-data:/tmp/tidb                            # persistent storage for TiDB data
    ports:
      - "4000:4000"   # mysql protocol
      - "10080:10080" # status server
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:10080/status"]
      interval: 3s
      timeout: 5s
      retries: 10
      start_period: 10s

  seed:
    image: mysql:8
    depends_on:
      tidb:
        condition: service_healthy
    volumes:
      - ./docs/tutorials/sample-data.sql:/seed/sample-data.sql:ro
    entrypoint: /bin/sh
    command:
      - -ec
      - |
        until mysqladmin --protocol=TCP --host=tidb --port=4000 --user=root ping --silent; do
          sleep 1
        done
        mysql --protocol=TCP --host=tidb --port=4000 --user=root < /seed/sample-data.sql
    restart: "no"

  tidb-graphql:
    image: ${TIGQL_IMAGE:-ghcr.io/benmeadowcroft/tidb-graphql:main}
    build:
      context: .
      dockerfile: Containerfile
      args:
        VERSION: ${VERSION:-dev}
        COMMIT: ${COMMIT:-none}
    ports:
      - "8080:8080"
    environment:
      - TIGQL_DATABASE_HOST=tidb
      - TIGQL_DATABASE_PORT=4000
      - TIGQL_DATABASE_DATABASE=tidb_graphql_tutorial
      - TIGQL_SERVER_GRAPHIQL_ENABLED=true
      - TIGQL_SERVER_TLS_MODE=off
      - TIGQL_OBSERVABILITY_LOGGING_FORMAT=text
      - TIGQL_OBSERVABILITY_ENVIRONMENT=development
    depends_on:
      tidb:
        condition: service_healthy

volumes:
  tidb-data:
