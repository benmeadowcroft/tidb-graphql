# OIDC + role-based authorization scenario for local development.
#
# Usage:
#   docker compose -f examples/compose/oidc-roles/docker-compose.yml up
#
# This stack starts:
# - TiDB with sample data
# - role grants + restricted DB user
# - local JWKS server at http://localhost:9000
# - tidb-graphql with OIDC + DB role authorization enabled

services:
  tidb:
    image: pingcap/tidb:v8.5.5
    command:
      - "--config=/tidb.toml"
    volumes:
      - ./config/tidb/tidb.toml:/tidb.toml:ro
      - tidb-data:/tmp/tidb
    ports:
      - "4000:4000"
      - "10080:10080"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:10080/status"]
      interval: 3s
      timeout: 5s
      retries: 10
      start_period: 10s

  seed-data:
    image: mysql:8
    depends_on:
      tidb:
        condition: service_healthy
    volumes:
      - ../../../docs/tutorials/sample-data.sql:/seed/sample-data.sql:ro
    entrypoint: /bin/sh
    command:
      - -ec
      - |
        until mysqladmin --protocol=TCP --host=tidb --port=4000 --user=root ping --silent; do
          sleep 1
        done
        mysql --protocol=TCP --host=tidb --port=4000 --user=root < /seed/sample-data.sql
    restart: "no"

  seed-roles:
    image: mysql:8
    depends_on:
      seed-data:
        condition: service_completed_successfully
    volumes:
      - ./seed/roles.sql:/seed/roles.sql:ro
    entrypoint: /bin/sh
    command:
      - -ec
      - |
        mysql --protocol=TCP --host=tidb --port=4000 --user=root < /seed/roles.sql
    restart: "no"

  jwks:
    image: golang:1.25
    working_dir: /workspace
    volumes:
      - ../../../:/workspace
    entrypoint: /bin/sh
    command:
      - -ec
      - |
        go run ./scripts/jwt-generate-keys --dir /workspace/.auth
        go run ./scripts/jwks-server --addr :9000 --issuer http://jwks:9000 --public-key /workspace/.auth/jwt_public.pem --tls=false --kid local-key
    ports:
      - "9000:9000"

  tidb-graphql:
    image: ${TIGQL_IMAGE:-ghcr.io/benmeadowcroft/tidb-graphql:main}
    build:
      context: ../../../
      dockerfile: Containerfile
      args:
        VERSION: ${VERSION:-dev}
        COMMIT: ${COMMIT:-none}
    volumes:
      - ./config/tidb-graphql/tidb-graphql.example.yaml:/etc/tidb-graphql/tidb-graphql.yaml:ro
    ports:
      - "8080:8080"
    depends_on:
      seed-roles:
        condition: service_completed_successfully
      jwks:
        condition: service_started
      tidb:
        condition: service_healthy

volumes:
  tidb-data:
