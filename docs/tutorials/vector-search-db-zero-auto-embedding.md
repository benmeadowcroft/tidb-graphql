# Vector search on TiDB Cloud Zero (auto-embedding)

This tutorial shows how to use TiDB Cloud Zero auto-embedding with vector search in `tidb-graphql`.

Goal: run semantic search with either:
- `queryText` (text mode, embedding generated by TiDB), or
- `vector` (explicit vector mode).

## Prerequisites

Run the DB Zero quickstart:

```bash
scripts/tidb-zero-prepare --invite <your-invitation-code> --database tidb_graphql_tutorial
docker compose -f examples/compose/quickstart-db-zero/docker-compose.yml up
```

This loads:
- `docs/tutorials/sample-data.sql`
- `docs/tutorials/sample-data-vectors-auto-embedding.sql`

## 1) Verify vector search field and args

```graphql
{
  __schema {
    queryType {
      fields {
        name
        args {
          name
        }
      }
    }
  }
}
```

Look for `searchProductReviewsByEmbeddingVector` and confirm it exposes `queryText`.

## 2) Text query mode (`queryText`)

Use `queryText` only.

```graphql
query {
  searchProductReviewsByEmbeddingVector(
    queryText: "portable battery for travel and charging"
    metric: COSINE
    first: 5
  ) {
    nodes {
      databaseId
      rating
      reviewText
      product {
        sku
        name
      }
      user {
        fullName
      }
    }
  }
}
```

## 3) Explicit vector mode (`vector`)

Use `vector` only. The auto-embedding model in this tutorial uses 1024 dimensions, so your input vector must also have 1024 values.

```graphql
query ($embedding: Vector!) {
  searchProductReviewsByEmbeddingVector(
    vector: $embedding
    metric: COSINE
    first: 5
  ) {
    nodes {
      databaseId
      rating
      reviewText
    }
  }
}
```

Example variables shape:

```json
{
  "embedding": [0.0123, -0.0044, 0.1188]
}
```

Replace the example values with a full 1024-element embedding.

## 4) Combine text mode with `where`

```graphql
query {
  searchProductReviewsByEmbeddingVector(
    queryText: "uncomfortable fit after long use"
    metric: COSINE
    first: 5
    where: { rating: { eq: THUMBS_DOWN } }
  ) {
    nodes {
      databaseId
      rating
      reviewText
    }
  }
}
```

## 5) Cursor pagination in text mode (`edges`)

When you need cursor/rank/distance metadata, use `edges` and `edge.node`.

Page 1:

```graphql
query {
  searchProductReviewsByEmbeddingVector(
    queryText: "desk setup and typing comfort"
    metric: COSINE
    first: 3
  ) {
    edges {
      cursor
      rank
      distance
      node {
        databaseId
        reviewText
      }
    }
    pageInfo {
      hasNextPage
      endCursor
    }
  }
}
```

Page 2:

```graphql
query {
  searchProductReviewsByEmbeddingVector(
    queryText: "desk setup and typing comfort"
    metric: COSINE
    first: 3
    after: "<endCursor-from-page-1>"
  ) {
    edges {
      rank
      distance
      node {
        databaseId
        reviewText
      }
    }
    pageInfo {
      hasNextPage
      endCursor
    }
  }
}
```

## Troubleshooting

- If you provide both `vector` and `queryText`, the query is rejected.
- If you provide neither `vector` nor `queryText`, the query is rejected.
- `queryText` is only available on auto-embedding vector columns.
- If vector search fields do not appear, confirm your table has a `VECTOR` column and `server.search.vector_require_index` is set for your environment.

---
# Related Docs

## Next steps
- [Vector search with embeddings](vector-search.md)
- [Query basics](query-basics.md)

## Back
- [Tutorials home](README.md)
- [Docs home](../README.md)
