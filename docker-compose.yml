# Development environment: TiDB + tidb-graphql
#
# Usage:
#   podman compose up        (or docker compose up)
#   podman compose up -d     (detached)
#   podman compose down      (stop and remove)
#   podman compose down -v   (stop and remove, including data volume)
#
# The GraphQL API will be available at http://localhost:8080/graphql
# TiDB MySQL protocol is exposed at localhost:4000
#
# On first run, sample data is loaded from docs/tutorials/sample-data.sql.
# Data persists across restarts in the 'tidb-data' volume.

services:
  tidb:
    image: pingcap/tidb:v8.5.5  # all-in-one TiDB image with TiKV and PD included
    command:
      - "--config=/tidb.toml"
      - "--initialize-sql-file=/init.sql" # Load tutorial data set on first run
    volumes:
      - ./config/tidb/tidb.toml:/tidb.toml:ro         # custom tidb configuration
      - ./docs/tutorials/sample-data.sql:/init.sql:ro # tutorial data set
      - tidb-data:/tmp/tidb                           # persistent storage for TiDB data
    ports:
      - "4000:4000"   # mysql protocol
      - "10080:10080" # status server

  tidb-graphql:
    build:
      context: .
      dockerfile: Containerfile
    ports:
      - "8080:8080"
    environment:
      - TIGQL_DATABASE_HOST=tidb
      - TIGQL_DATABASE_PORT=4000
      - TIGQL_DATABASE_DATABASE=tidb_graphql_tutorial # connect to the tutorial database
    depends_on:
      - tidb

volumes:
  tidb-data:
