# TiDB GraphQL Configuration File
# Copy this file to tidb-graphql.yaml and customize as needed
# The server searches for config files in the following locations (in order):
#   1. /etc/tidb-graphql/tidb-graphql.yaml
#   2. $HOME/.tidb-graphql/tidb-graphql.yaml
#   3. ./tidb-graphql.yaml (current directory)
#
# See ./docs/reference/configuration.md for details on configuration settings

# Database configuration
database:
  # Option 1: Connection string (DSN) - overrides host/port/user/password/database
  # Format: user:password@tcp(host:port)/database?params
  # dsn: "root:@tcp(localhost:4000)/test"
  # dsn_file: "/run/secrets/tidb-dsn"  # Path to file containing DSN (use @- for stdin)

  # Option 2: Discrete connection fields (used when DSN is not set)
  host: localhost
  port: 4000
  user: root
  # password: ""  # Leave empty to use --database.password-prompt flag for secure input
  # password_file: "" # Path to file containing the password (use @- for stdin)
  database: test

  # TLS configuration for database connections
  tls:
    # mode: off            # TLS mode: off, skip-verify, verify-ca, verify-full
    # ca_file: ""          # Path to CA certificate for server verification
    # ca_file_env: ""      # Env var containing CA certificate path (for K8s secrets)
    # cert_file: ""        # Path to client certificate for mTLS
    # cert_file_env: ""    # Env var containing client certificate path
    # key_file: ""         # Path to client private key for mTLS
    # key_file_env: ""     # Env var containing client key path
    # server_name: ""      # Override TLS server name for verification

  # Connection pool settings
  pool:
    max_open: 25           # Maximum number of open connections
    max_idle: 5            # Maximum number of idle connections in pool
    max_lifetime: 5m       # Connection max lifetime

  # Startup connection behavior
  connection_timeout: 60s       # Max time to wait for DB on startup (0 = fail immediately)
  connection_retry_interval: 2s # Initial interval between connection retries

# Server configuration
server:
  port: 8080
  graphql_max_depth: 5         # Maximum GraphQL query depth
  graphql_max_complexity: 0    # Maximum estimated complexity (0 = unlimited)
  graphql_max_rows: 0          # Maximum estimated rows per request (0 = unlimited)
  graphql_default_limit: 100   # Default page size for GraphQL connection collection queries
  schema_refresh_min_interval: 30s  # Minimum interval between schema refresh checks
  schema_refresh_max_interval: 5m   # Maximum interval between schema refresh checks
  graphiql_enabled: false      # Enable GraphiQL UI for /graphql (dev only)

  # HTTP server timeouts
  read_timeout: 15s            # HTTP server read timeout
  write_timeout: 15s           # HTTP server write timeout
  idle_timeout: 60s            # HTTP server idle timeout
  shutdown_timeout: 30s        # Graceful shutdown timeout
  health_check_timeout: 2s     # Health check timeout

  # Authentication & authorization
  auth:
    oidc_enabled: false             # Enable OIDC/JWKS authentication middleware
    oidc_issuer_url: ""             # OIDC issuer URL (discovery + JWKS)
    oidc_audience: ""               # Expected JWT audience (client ID)
    oidc_clock_skew: 2m             # Allowed JWT clock skew
    oidc_skip_tls_verify: false     # Skip TLS verification for OIDC provider (dev only)
    db_role_enabled: false          # Enable database role authorization (SET ROLE)
    db_role_claim_name: "db_role"   # JWT claim for DB role
    db_role_validation_enabled: true # Validate db_role against discovered roles
    db_role_introspection_role: ""  # Database role used for schema introspection
    role_schema_include: ["*"]      # Role glob patterns to include for role-specific schemas
    role_schema_exclude: []          # Role glob patterns to exclude from role-specific schemas
    role_schema_max_roles: 64        # Hard cap on number of role-specific schemas built

  # Rate limiting (disabled by default)
  rate_limit_enabled: false    # Enable global rate limiting for all endpoints
  rate_limit_rps: 0            # Requests per second (set > 0 when enabled)
  rate_limit_burst: 0          # Burst size (set > 0 when enabled)

  # CORS configuration (disabled by default)
  cors_enabled: false                # Enable CORS for browser-based clients
  cors_allowed_origins:             # Allowed origins (use ["*"] for all)
    - "http://localhost:3000"
  cors_allowed_methods:              # Allowed HTTP methods
    - GET
    - POST
    - OPTIONS
  cors_allowed_headers:              # Allowed request headers
    - Content-Type
    - Authorization
  cors_expose_headers:               # Headers exposed to browser
    - X-Request-ID
  cors_allow_credentials: false      # Allow cookies/auth headers (requires specific origins)
  cors_max_age: 86400                # Preflight cache duration (seconds)

  # TLS/HTTPS configuration
  tls_mode: "off"              # TLS mode: off, auto (self-signed), file (default: off)

  # File mode: Use existing certificate files (production)
  tls_cert_file: ""            # Path to TLS certificate
  tls_key_file: ""             # Path to TLS private key

  # Auto mode: Generate self-signed certificate (development only)
  tls_auto_cert_dir: .tls      # Directory for generated certificates

# Observability configuration
observability:
  service_name: tidb-graphql        # Service name for metrics/traces/logs
  service_version: 1.0.0            # Service version
  environment: production           # Environment: development, staging, production

  # Metrics configuration
  metrics_enabled: true             # Enable OpenTelemetry metrics collection (Prometheus)

  # Distributed tracing configuration
  tracing_enabled: false            # Enable OpenTelemetry distributed tracing
  sqlcommenter_enabled: true        # Inject trace context into SQL queries (requires tracing_enabled: true)

  # Logging configuration
  logging:
    level: info                     # Stdout log level: debug, info, warn, error
    format: json                    # Stdout log format: json (structured), text (human-readable)
    exports_enabled: false          # Enable OTLP log export to remote backend

  # Global OTLP configuration (defaults for all signals: traces, logs)
  otlp:
    protocol: grpc                  # OTLP protocol: grpc or http/protobuf
    endpoint: localhost:4317        # OTLP endpoint (grpc uses host:port; http/protobuf can use https://host:port)
    insecure: false                 # Use insecure connection (no TLS)
    tls_cert_file: ""               # Path to CA certificate for server verification
    tls_client_cert_file: ""        # Path to client certificate for mTLS
    tls_client_key_file: ""         # Path to client key for mTLS
    headers: {}                     # Custom headers (e.g., Authorization: Bearer token)
    timeout: 10s                    # Export timeout duration
    compression: gzip               # Compression type: none, gzip
    retry_enabled: true             # Enable retry on transient errors
    retry_max_attempts: 3           # Maximum retry attempts

  # Signal-specific overrides (optional)
  # Uncomment and configure to send different signals to different backends

  # traces:
  #   protocol: http/protobuf
  #   endpoint: https://api.honeycomb.io
  #   insecure: false
  #   headers:
  #     x-honeycomb-team: "your-api-key"
  #     x-honeycomb-dataset: "tidb-graphql"
  #   timeout: 30s

  # logs:
  #   protocol: grpc
  #   endpoint: logs-prod.grafana.net:443
  #   insecure: false
  #   headers:
  #     Authorization: "Bearer your-loki-token"
  #   timeout: 15s

# Schema filtering (allow/deny with glob patterns)
schema_filters:
  allow_tables: ["*"]       # Glob patterns of tables to include (empty = allow all)
  deny_tables: ["*_intern"] # Glob patterns of tables to exclude
  deny_mutation_tables: []  # Glob patterns of tables to exclude from mutations
  scan_views_enabled: false # Include SQL views in schema introspection
  allow_columns:
    "*": ["*"]              # Glob patterns of columns per table (use "*" for all tables)
  deny_columns:
    "*": ["*_secret"]       # Glob patterns of columns to exclude per table
  deny_mutation_columns:
    "*": ["*_readonly"]     # Glob patterns of columns to exclude from mutation inputs

# Naming configuration (optional overrides for pluralization/singularization)
naming:
  plural_overrides:
    staff: staff
    criterion: criteria
  singular_overrides:
    criteria: criterion

# Notes:
# - Environment variables can override these settings with TIGQL_ prefix
#   Example: TIGQL_DATABASE_HOST=myhost TIGQL_DATABASE_PORT=3306
#   Example: TIGQL_DATABASE_DSN="root:pass@tcp(host:4000)/db"
#   Example: TIGQL_OBSERVABILITY_LOGGING_LEVEL=debug
# - Command line flags override both config file and environment variables
#   Example: --database.host=myhost --database.tls.mode=verify-full
#   Example: --database.dsn="root:pass@tcp(host:4000)/db"
# - For secure password input, use: --database.password-prompt
